# CARLA World Model 项目调试记录

本文档记录了项目开发过程中遇到的问题和解决方案。

---

## 1. 环境验证 (check_env.py)

### 问题
在项目初期，需要验证所有依赖是否正确安装，特别是CARLA Python API和CUDA支持。

### 解决方案
创建了环境检查脚本，验证：
- PyTorch及CUDA支持
- OpenCV、NumPy等核心依赖
- CARLA Python API (carla==0.9.15)
- GPU检测（显存、设备数量）

### 结论
环境验证通过，所有依赖正确安装。

---

## 2. CARLA连接测试 (minimal_test.py)

### 问题
需要验证能否成功连接CARLA服务器并采集图像。

### 测试内容
- 连接到localhost:2000
- 生成Tesla Model 3车辆
- 设置256×256 RGB相机
- 采集单张测试图像

### 结论
基础连接功能正常，但发现同步模式问题。

---

## 3. 同步模式问题 (sync_test.py)

### 问题
在默认异步模式下，图像采集和车辆控制不同步，导致：
- 帧间对应关系不准确
- 动作和图像时间戳不匹配

### 解决方案
启用CARLA同步模式：
```python
settings = world.get_settings()
settings.synchronous_mode = True
settings.fixed_delta_seconds = 0.05  # 20 FPS
world.apply_settings(settings)
```

关键：使用`world.tick()`手动推进模拟，而不是依赖`time.sleep()`。

### 结论
同步模式解决了帧对应问题，确保动作和图像严格对齐。

---

## 4. 快速采集测试 (quick_collect.py)

### 问题
需要在正式采集前验证整个数据收集流程。

### 配置
- 5个episodes × 50帧 = 250帧测试数据
- 图像尺寸：256×256
- 动作：70%概率大转向（±0.6），30%直行

### 发现的问题
- 代码缩进错误导致try-except块失效
- 需要尝试多个出生点避免碰撞

### 结论
测试流程验证通过，可以进行大规模采集。

---

## 5. 数据质量验证 (verify_data.py)

### 问题
采集的数据质量是否足够训练世界模型？主要关注转向动作的可见性。

### 验证内容
1. **动作分布统计**
   - 转向范围：[-0.6, 0.6]
   - 大转向比例（|steering|>0.3）

2. **帧间差异检测**
   - 对比转向前后的图像
   - 计算L1距离

### 初始结论
5帧间隔的转向效果不明显（差异<5），需要改进。

---

## 6. 改进的数据验证 (verify_data_v2.py)

### 问题
原始验证只检查5帧间隔，转向效果不明显。

### 改进
测试多种帧间隔：5、10、15、20、30帧

### 验证结果
| 帧间隔 | 时间(秒) | L1差异 | 评价 |
|--------|----------|--------|------|
| 5      | 0.25     | <5     | 微弱 |
| 10     | 0.50     | 5-10   | 中等 |
| 15     | 0.75     | 10-15  | 明显 |
| 20     | 1.00     | >15    | 非常明显 |
| 30     | 1.50     | >20    | 非常明显 |

### 结论
世界模型使用4帧上下文（约0.2秒），预测未来帧时转向效果可见。
采用更丰富的转向动作（70%大转向）确保数据质量。

---

## 7. 输出验证图像 (outputs/)

验证过程生成的对比图像：
- `action_distribution.png` - 动作分布直方图
- `steering_comparison.png` - 原始转向对比
- `steering_comparison_Xframes.png` - 不同帧间隔对比（X=5,10,15,20,30）

这些图像用于视觉确认数据质量，现已不再需要。

---

## 总结

### 主要问题与解决
1. **CARLA同步模式** → 使用`synchronous_mode=True`和`world.tick()`
2. **转向可见性不足** → 增加转向幅度和概率
3. **数据验证** → 多帧间隔测试确认效果

### 最终数据配置
- 10,000帧，Town03地图
- 256×256 RGB图像
- 动作：[steering, throttle]，2维
- 70%大转向（±0.6），30%直行
- 20 FPS采样率

### 后续流程
1. VQ-VAE训练 → 完成（best loss: 0.0096）
2. Token导出 → 完成（10000×16×16 tokens）
3. World Model训练 → 进行中（238M参数）
4. 视频生成测试 → 待完成

---

*文档生成时间：2026-01-11*
